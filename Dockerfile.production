# Production Dockerfile - Single container with everything
# Works on Railway, Render, Fly.io, and any Docker platform
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    postgresql-client \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Create comprehensive startup script that handles everything
RUN cat > /start.sh << 'STARTEOF'
#!/bin/bash
set -e

echo "ðŸš€ Starting MasterTrader..."

# Use Railway/Render/Fly.io environment variables or defaults
DB_HOST=${DATABASE_URL:-${PGHOST:-${DB_HOST:-localhost}}}
DB_PORT=${PGPORT:-${DB_PORT:-5432}}
DB_NAME=${PGDATABASE:-${DB_NAME:-mastertrader}}
DB_USER=${PGUSER:-${DB_USER:-trader}}
DB_PASSWORD=${PGPASSWORD:-${DB_PASSWORD:-traderpw}}

# Parse DATABASE_URL if provided (Railway/Render format)
if [ -n "${DATABASE_URL:-}" ]; then
    # Parse postgresql://user:pass@host:port/dbname or postgresql://user:pass@host/dbname
    # Remove protocol prefix
    DB_INFO=$(echo $DATABASE_URL | sed 's|^postgresql://||' | sed 's|^postgres://||')
    # Extract user:pass@host:port/dbname
    DB_USER_PASS=$(echo $DB_INFO | cut -d'@' -f1)
    DB_HOST_PORT_DB=$(echo $DB_INFO | cut -d'@' -f2)
    DB_USER=$(echo $DB_USER_PASS | cut -d':' -f1)
    DB_PASSWORD=$(echo $DB_USER_PASS | cut -d':' -f2-)
    # Extract host:port/dbname
    DB_HOST_PORT=$(echo $DB_HOST_PORT_DB | cut -d'/' -f1)
    DB_NAME=$(echo $DB_HOST_PORT_DB | cut -d'/' -f2)
    # Extract host and port
    if echo "$DB_HOST_PORT" | grep -q ':'; then
        DB_HOST=$(echo $DB_HOST_PORT | cut -d':' -f1)
        DB_PORT=$(echo $DB_HOST_PORT | cut -d':' -f2)
    else
        DB_HOST=$DB_HOST_PORT
        DB_PORT=5432
    fi
fi

export PG_DSN="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}"

echo "ðŸ“Š Database: ${DB_HOST}:${DB_PORT}/${DB_NAME}"

# Wait for database
echo "â³ Waiting for database..."
until pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" 2>/dev/null; do
    echo "   Still waiting..."
    sleep 2
done
echo "âœ… Database ready!"

# Run migrations
echo "ðŸ“¦ Running migrations..."
python3 << PYEOF
import psycopg
import os
import glob

dsn = os.getenv('PG_DSN')
conn = psycopg.connect(dsn)

# Run all migrations (skip 000_temporal.sql on cloud - database already exists)
migration_files = sorted(glob.glob('infra/migrations/*.sql'))
for migration_file in migration_files:
    # Skip temporal database creation on cloud (database already exists)
    if '000_temporal.sql' in migration_file:
        print(f"â­ï¸  {migration_file} (skipped - database exists)")
        continue
    
    try:
        with open(migration_file, 'r') as f:
            sql = f.read()
            # Execute in autocommit mode for DDL statements
            conn.autocommit = True
            conn.execute(sql)
            conn.autocommit = False
        print(f"âœ… {migration_file}")
    except Exception as e:
        # If error, try to continue with next migration
        print(f"âš ï¸  {migration_file}: {e}")
        try:
            conn.rollback()
        except:
            pass

conn.close()
PYEOF

# Start gateway
echo "ðŸš€ Starting gateway on port ${PORT:-8000}..."
exec python3 -m uvicorn apps.gateway.app:app --host 0.0.0.0 --port ${PORT:-8000}
STARTEOF

RUN chmod +x /start.sh

EXPOSE 8000

CMD ["/start.sh"]
