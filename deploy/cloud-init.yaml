## cloud-init user-data for trader stack
#cloud-config
package_update: true
package_upgrade: true
packages:
  - docker.io
  - docker-compose-plugin
  - git
  - jq

users:
  - default
  - name: ubuntu
    groups: [sudo, docker]
    shell: /bin/bash

write_files:
  - path: /home/ubuntu/.env
    owner: ubuntu:ubuntu
    permissions: '0644'
    content: |
      # Core venues and friction
      BINANCE_API_KEY=${BINANCE_API_KEY}
      BINANCE_API_SECRET=${BINANCE_API_SECRET}
      BINANCE_BASE=${BINANCE_BASE:-https://testnet.binance.vision}
      BINANCE_FRICTION_BASE=${BINANCE_FRICTION_BASE:-https://api.binance.us}

      # Agent / OpenAI
      AGENT_MODE=${AGENT_MODE:-llm}
      OPENAI_API_KEY=${OPENAI_API_KEY}
      OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}

      # Executor / Modes
      EXECUTOR_MODE=${EXECUTOR_MODE:-live}

      # Routing / dispatcher
      DISPATCHER_SYMBOLS=${ALLOWED_SYMBOLS:-BTCUSDT,ETHUSDT}
      DISPATCHER_ASLF_POLL_S=${DISPATCHER_ASLF_POLL_S:-15}
      DISPATCHER_NOTIONAL=${DISPATCHER_NOTIONAL:-25}

      # Gates / knobs
      ALLOWED_SYMBOLS=${ALLOWED_SYMBOLS:-BTCUSDT,ETHUSDT}
      CONSENSUS_MIN=${CONSENSUS_MIN:-0.55}
      ASLF_THETA_BUY=${ASLF_THETA_BUY:-0.8}
      PROBE_SIZE_BPS=${PROBE_SIZE_BPS:-3}
      FRACTIONAL_KELLY_MAX=${FRACTIONAL_KELLY_MAX:-0.08}

  - path: /etc/systemd/system/trader.service
    owner: root:root
    permissions: '0644'
    content: |
      [Unit]
      Description=Trader stack (docker compose)
      Wants=network-online.target docker.service
      After=network-online.target docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/home/ubuntu/trader
      Environment=COMPOSE_FILE=infra/docker-compose.yml
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target

runcmd:
  - timedatectl set-timezone UTC
  - systemctl enable --now docker
  - usermod -aG docker ubuntu
  - su - ubuntu -c "if [ ! -d /home/ubuntu/trader ]; then git clone https://github.com/${GITHUB_REPOSITORY}.git /home/ubuntu/trader; else cd /home/ubuntu/trader && git pull --ff-only; fi"
  - su - ubuntu -c "install -m 0644 /home/ubuntu/.env /home/ubuntu/trader/.env"
  - systemctl daemon-reload
  - systemctl enable trader
  - systemctl start trader

final_message: "Trader stack cloud-init complete."


